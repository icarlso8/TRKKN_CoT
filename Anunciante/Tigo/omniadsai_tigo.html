<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OmniAdsAI_Tigo</title>
  <link rel="icon" href="../../assets/TRKKN_icon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Mulish:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Mulish', sans-serif;
      background: #fff;
      color: #000;
      padding: 20px;
    }
    form {
      display: flex;
      flex-direction: column;
      gap: 16px;
      max-width: 540px;
      padding: 2px;
    }
    .form-section {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }
    .textarea-jerarquia {
      display: block;
      width: 100%;
      margin-right: 10px;
      box-sizing: border-box;
      resize: vertical;
    }
    .canvas-wrapper {
      display: flex;
      flex-wrap: wrap;
      gap: 20px;
      margin-top: 20px;
    }
    canvas {
      border: 1px solid #ccc;
    }
    fieldset.form-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 6px; /* Interlineado entre secciones */
    }
    legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
    fieldset.form-group .form-section,
    fieldset.form-group > div.form-section {
      margin-bottom: 12px;
    }
    select {
      padding: 6px 8px;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-family: 'Mulish', sans-serif;
      max-width: 260px;
      color: #000;
      background-color: #fff;
    } 
    .label-wrapper {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      min-width: 100%;
    }
    .label-wrapper label {
      min-width: 160px;
      text-align: right;
    }
    .label-wrapper select {
      flex: 1;
    }
    /* Sangr√≠a y alineaci√≥n para checkboxes en m√∫ltiples l√≠neas */
    .form-section label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      font-size: 15px;
    }
    .form-section label input[type="checkbox"] {
      margin-top: 2px;
      margin-right: 6px;
      flex-shrink: 0;
    }
    .form-section label span {
      display: inline;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .form-section.checkbox-opciones {
      margin-left: 24px;
    }
    .galeria-thumbs {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
      justify-content: flex-start;
      max-width: 100%;
      overflow-x: auto;
    }
    .thumbnail-preview {
      width: 60px;
      height: auto;
      border: 1px solid #ccc;
      cursor: pointer;
      transition: transform 0.2s;
      box-shadow: 1px 1px 4px rgba(0, 0, 0, 0.1);
    }
    .thumbnail-preview:hover {
      transform: scale(1.05);
      border-color: #555;
    }
    /* Galer√≠a global de resultados */
    #resultados {
      margin-top: 32px;
      border-top: 1px solid #eee;
      padding-top: 20px;
    }
    #resultados h2 {
      margin: 0 0 12px 0;
      font-size: 18px;
    }
    #galeriaResultados {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 12px;
      align-items: start;
    }
    .thumb-wrapper {
      background: #fff;
      padding: 8px;
      border-radius: 6px;
      box-shadow: 0 1px 4px rgba(0,0,0,0.06);
      text-align: center;
    }
    .thumb-wrapper .thumbnail-preview {
      width: 100%;
      height: auto;
      cursor: pointer;
      border-radius: 4px;
    }
    .thumb-wrapper .thumb-title {
      font-size: 12px;
      margin-top: 6px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .thumb-wrapper a.download-link {
      display:block;
      margin-top:6px;
      font-size:12px;
      color:#0b66c3;
      text-decoration:none;
    }
    .fila1, .fila2 {
      display: flex;
      flex-wrap: wrap;
      gap: 2px;               /* üîπ espacio entre elementos dentro de la fila, controla el espacio horizontal y vertical entre los botones dentro de la misma fila. */
      margin-bottom: 2px;
    }
    /* Tama√±o uniforme para botones */
    .fila1 button,
    .fila2 button {
      width: 30px;           /* ancho */
      height: 30px;          /* alto */
      font-size: 20px;       /* tama√±o de emoji o texto */
      padding: 0;
      border-radius: 6px;
      box-sizing: border-box; /* asegura tama√±o exacto incluyendo bordes */
    }
    /* Tama√±o uniforme para selects y color pickers */
    .fila1 select,
    .fila2 select,
    .fila1 input[type="color"],
    .fila2 input[type="color"] {
      width: 30px;
      height: 30px;
      padding: 0;
      border-radius: 6px;
      box-sizing: border-box;
    }
    /* Sliders m√°s compactos */
    .fila1 input[type="range"],
    .fila2 input[type="range"] {
      height: 20px;
      box-sizing: border-box;
    }
    #main-container {
      display: flex;
      gap: 20px;
    }
    
    #col-formularios,
    #col-canvas,
    #col-gemini {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }
    #col-canvas {
      overflow-y: auto;
      max-height: 90vh; /* se ajusta a la altura de la pantalla */
    }
    .canvas-column-group {
      border: 1px solid #ddd;
      border-radius: 8px;
      padding: 16px;
    }
    
    .canvas-column-group legend {
      font-weight: bold;
      font-size: 1.1em;
      padding: 0 10px;
    }
  </style>
  <script type="module" src="./js/auth.js"></script>
</head>
  
<body style="display:none">
  <h1><img src="logo_omniadsai_tigo.png" alt="Cargando Logo Tigo OmniAdsAI TRKKN..." style= "width: 500px; margin-left: 20px" /></h1>

  <div id="main-container" style="display: flex; gap: 20px; align-items: flex-start;">

    <!-- Columna izquierda: Formularios -->
    <div id="col-formularios" style="flex: 1; max-width: 540px; display: flex; flex-direction: column; gap: 16px;">
      <form id="formulario"></form>
    </div>

    <!-- Columna central: Canvas -->
    <div id="col-canvas" style="flex: 2; display: flex; flex-direction: column; gap: 20px;">
      <fieldset class="canvas-column-group">
        <legend>üé® Tama√±os / Plantillas</legend>
        <div class="canvas-wrapper" id="canvasContainer"></div>
      </fieldset>
    </div>

    <!-- Columna derecha: Gemini AI -->
    <div id="col-gemini" style="flex: 1; max-width: 400px; display: flex; flex-direction: column; gap: 16px;">
      <fieldset class="canvas-column-group">
        <legend>
          <img src="./logo_gemini.png" alt="logo_gemini" style="height: 40px; vertical-align: middle; margin-right: 4px;">
          <img src="./logo_leoai.png" alt="logo_gemini" style="height: 40px; vertical-align: middle; margin-right: 4px;">
          Agentes
        </legend>
        <textarea id="gemini-prompt" rows="10" style="width:100%;"></textarea>
        <button id="gemini-generar" type="button">Generar</button>
        <div id="gemini-output"></div>
      </fieldset>
    </div>

  </div>

  <script type="module">
    import { cargarJerarquia } from "./js/infoProduct.js";
    import { cargarAudienciaFactores } from "./js/audienciaFactores.js";
    import { borradoPorTeclado } from "./js/controlesCanvas.js";
    import { cargarTamanosYCanvas } from "./js/canvasLoader.js";
    
    document.addEventListener("DOMContentLoaded", async () => {
      await cargarJerarquia(); // carga productos en select
      // cargar audiencias y factores vac√≠os inicialmente (pasamos string vac√≠o)
      await cargarAudienciaFactores("");
      await borradoPorTeclado();
      // await cargarTamanosYCanvas(); NO LLAMAR cargarTamanosYCanvas() al cargar la p√°gina (antes s√≠ la llamabas al cargar audiencias).
      
      // Al cambiar el producto en el dropdown recarga audiencias y factores
      const productoSelect = document.getElementById("producto");
      productoSelect.addEventListener("change", async () => {
        await cargarAudienciaFactores(productoSelect.value);
        await cargarTamanosYCanvas();
      });
    });
  </script>
  
  <script type="module">
    import { mostrarGaleriaLogos, mostrarGaleriaIconos, agregarTexto, limpiarCanvas, crearControlesTexto } from "../../Anunciante/Tigo/js/controlesCanvas.js";
  
    document.addEventListener("DOMContentLoaded", () => {
      const intervalo = setInterval(() => {
        if (window.canvasRefs) {
          clearInterval(intervalo);
  
          for (const [id, ref] of Object.entries(window.canvasRefs)) {
            const controls = document.createElement("div");
            controls.style.display = "flex";
            controls.style.gap = "10px";
            controls.style.marginTop = "10px";
            controls.style.marginBottom = "20px";
  
            const btnLogo = document.createElement("button");
            btnLogo.textContent = "¬ÆÔ∏è";
            btnLogo.title = "A√±adir logo";
            btnLogo.onclick = () => {
              mostrarGaleriaLogos(ref.canvas);
            };
  
            const btnIcono = document.createElement("button");
            btnIcono.textContent = "‚ÑπÔ∏è";
            btnIcono.title = "A√±adir √≠cono";
            btnIcono.onclick = () => {
              mostrarGaleriaIconos(ref.canvas);
            };
  
            const btnTexto = document.createElement("button");
            btnTexto.textContent = "‚úèÔ∏è";
            btnTexto.title = "A√±adir texto";
            btnTexto.onclick = () => {
              agregarTexto(ref.canvas);
            };
  
            const btnLimpiar = document.createElement("button");
            btnLimpiar.textContent = "üîÑ";
            btnLimpiar.title = "Limpiar canvas";
            btnLimpiar.onclick = () => {
              limpiarCanvas(ref.canvas);
            };
  
            controls.appendChild(btnLogo);
            controls.appendChild(btnIcono);
            controls.appendChild(btnTexto);
            controls.appendChild(btnLimpiar);

            const [fontSelector, colorPicker, shadowToggle, shadowColorPicker, shadowOpacitySlider] = crearControlesTexto(ref);
            controls.appendChild(fontSelector);
            controls.appendChild(colorPicker);
            controls.appendChild(shadowToggle);
            controls.appendChild(shadowColorPicker);
            controls.appendChild(shadowOpacitySlider);

            // Crear contenedor de miniaturas (galer√≠a)
            const galeria = document.createElement("div");
            galeria.className = "galeria-thumbs";
            galeria.id = `galeria_${id}`;
            ref.galeriaId = galeria.id; // Guarda el ID por si lo necesitas luego
  
            ref.canvas.wrapperEl.parentElement.appendChild(controls);
            // Insertar la galer√≠a en el DOM
            ref.canvas.wrapperEl.parentElement.appendChild(galeria);
          }
        }
      }, 200);
    });
  </script>

  <!-- Modal para elegir logo -->
  <div id="modalLogos" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:90%; max-height:80%; overflow:auto;">
      <h3>Selecciona un logo</h3>
      <div id="galeriaLogos" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
      <button onclick="document.getElementById('modalLogos').style.display='none'" style="margin-top:10px;">Cerrar</button>
    </div>
  </div>

  <!-- Modal para elegir √≠cono -->
  <div id="modalIconos" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.6); z-index:999; justify-content:center; align-items:center;">
    <div style="background:white; padding:20px; border-radius:8px; max-width:90%; max-height:80%; overflow:auto;">
      <h3>Selecciona un √≠cono</h3>
      <div id="galeriaIconos" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
      <button onclick="document.getElementById('modalIconos').style.display='none'" style="margin-top:10px;">Cerrar</button>
    </div>
  </div>

  <script type="module">
    import { generarCreatividadesConFondos } from "../../Anunciante/Tigo/js/controlesCanvas.js";
  
    function obtenerValoresSeleccionados(name) {
      return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(el => el.value);
    }
    
    function obtenerFactorYOpciones() {
      const factores = {};
      const inputs = document.querySelectorAll('fieldset.form-group input[type="checkbox"]');
      inputs.forEach(input => {
        const nombre = input.name;
        if (!factores[nombre]) factores[nombre] = [];
        if (input.checked) factores[nombre].push(input.value);
      });
      return factores;
    }
    
    document.addEventListener("DOMContentLoaded", () => {
      const btnGenerar = document.createElement("button");
      btnGenerar.textContent = "üöÄ Generar creatividades";
      btnGenerar.style.maxWidth = "250px";
      btnGenerar.style.overflow = "hidden";
      btnGenerar.style.textOverflow = "ellipsis";
      btnGenerar.style.marginTop = "16px";
      btnGenerar.style.padding = "12px 10px";
      btnGenerar.style.fontSize = "18px";
      btnGenerar.style.fontWeight = "bold";
      btnGenerar.style.borderRadius = "8px";
      btnGenerar.style.backgroundColor = "#4CAF50";
      btnGenerar.style.color = "#fff";
      btnGenerar.style.border = "none";
      btnGenerar.style.cursor = "pointer";
    
      document.getElementById("formulario").insertAdjacentElement("afterend", btnGenerar);

      btnGenerar.onclick = () => {
        const galeriaGlobal = document.getElementById("galeriaResultados");
        if (!galeriaGlobal) return;
        galeriaGlobal.innerHTML = "";
      
        const audiencias = obtenerValoresSeleccionados("audiencia");
        const factores = obtenerFactorYOpciones();
        const productoSelect = document.getElementById("producto");
        const nombreProducto = productoSelect?.value || "producto";
        const canvasRefs = window.canvasRefs || {};
      
        // construir combinaciones (audiencia x factor x opcion x tama√±o)
        const combos = [];
        audiencias.forEach(audId => {
          for (const factorId in factores) {
            if (factorId.toLowerCase() === "audiencia" || factorId.toLowerCase() === "tamanos") continue; // Ignorar factor "tamanos"
            factores[factorId].forEach(opcionId => {
              for (const tama√±oId in canvasRefs) {
                const ref = canvasRefs[tama√±oId];
                if (!ref.activo) continue;
                combos.push({ ref, audId, factorId, opcionId, tama√±oId });
              }
            });
          }
        });

        if (combos.length === 0) {
          alert("‚ö†Ô∏è No hay creatividades para generar (revisa tus selecciones).");
          return;
        }
      
        // contador por combinaci√≥n (no por imagen) ‚Äî esperamos a que cada combinaci√≥n marque done = true
        let pendientes = combos.length;
        const rutasFaltantes = new Set();
        let generadas = 0;
      
        combos.forEach(c => {
          generarCreatividadesConFondos(
            c.ref.canvas,
            c.audId,
            c.factorId,
            c.opcionId,
            c.tama√±oId,
            nombreProducto,
            (dataURL, nombreCreatividad, fondoNoEncontrado, rutasProbadas, done) => {
              // rutas sin fondos (fondos.json no existe)
              if (fondoNoEncontrado) {
                (rutasProbadas || []).forEach(r => rutasFaltantes.add(r));
              }
      
              // recibimos una creatividad lista ‚Üí mostrarla y contarla
              if (dataURL) {
                generadas++;
                const wrapper = document.createElement("div");
                wrapper.className = "thumb-wrapper";
      
                const img = document.createElement("img");
                img.src = dataURL;
                img.className = "thumbnail-preview";
                img.title = nombreCreatividad;
                img.onclick = () => window.open(dataURL, "_blank");
      
                const title = document.createElement("div");
                title.className = "thumb-title";
                title.textContent = nombreCreatividad;
      
                const download = document.createElement("a");
                download.href = dataURL;
                download.download = nombreCreatividad;
                download.className = "download-link";
                download.textContent = "Descargar";
      
                wrapper.appendChild(img);
                wrapper.appendChild(title);
                wrapper.appendChild(download);
                galeriaGlobal.appendChild(wrapper);
              }
      
              // cuando la combinaci√≥n indique done=true, restamos pendientes
              if (done) {
                pendientes--;
                if (pendientes === 0) {
                  // Esperar a que el DOM termine de insertar y renderizar la √∫ltima creatividad
                  requestAnimationFrame(() => {
                    requestAnimationFrame(() => {
                      let mensaje = `üéâ ${generadas} creatividades generadas correctamente.`;
                      if (rutasFaltantes.size > 0) {
                        mensaje += `\n‚ö†Ô∏è ${rutasFaltantes.size} rutas que no cuentan con fondos.`;
                        mensaje += `\n\nüìÇ Rutas faltantes:\n- ${Array.from(rutasFaltantes).join("\n- ")}`;
                      }
                      alert(mensaje);
                    });
                  });
                }
              }
            }
          );
        });
      };  // üëà cierre de la funci√≥n onclick 
    });  // üëà cierre del DOMContentLoaded
  </script> <!-- üëà cierre del bloque script -->
  
  <section id="resultados">
    <h2>üéûÔ∏è Creatividades generadas</h2>
    <div id="galeriaResultados"></div>
  </section>

  </body>
</html>
