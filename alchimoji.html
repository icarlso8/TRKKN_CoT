<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Alchimoji</title>
  <!-- <link rel="icon" href="https://cdn.jsdelivr.net/gh/icarlso8/TRKKN_CoT/assets/logos/logo_claro_v1.png"> -->
  <link rel="icon" href="assets/TRKKN_icon.png" type="image/png" />
  <link href="https://fonts.googleapis.com/css2?family=Mulish&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
  body {
    margin: 0;
    font-family: 'Mulish', sans-serif;
    background: #ffffff; /* ← Fondo blanco */
    color: #000000;       /* ← Texto oscuro para contraste */
  }

  form {
    display: flex;
    flex-direction: column;
    align-items: flex-start;
    justify-content: flex-start;
    max-width: 1080px;
    /*margin: 0 auto;*/
    margin-left: 40px;
    gap: 20px;
  }

  .form-section {
    display: flex;
    flex-wrap: wrap;
    align-items: flex-start;
    justify-content: flex-start;
    gap: 12px;
    width: 100%;
  }

  .form-section strong {
    min-width: 160px;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .form-section label {
    white-space: nowrap;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  input[type="text"] {
    padding: 6px 8px;
    border-radius: 6px;
    /*border: none;*/
    border: 1px solid #ccc;
    font-family: 'Mulish', sans-serif;
    max-width: 260px;
    color: #000; /* texto negro */
    background-color: #fff; /* fondo blanco */
  }

  input[type="color"],
  select {
    padding: 4px;
    border-radius: 6px;
    font-family: 'Mulish', sans-serif;
  }

  input[type="checkbox"] {
    transform: scale(1.2);
  }

  button {
    font-family: 'Mulish', sans-serif;
    padding: 10px 16px;
    background-color: #00C6AE;
    color: #000;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    margin-right: 10px;
  }

  button:hover {
    background-color: #00b39b;
  }
  </style>

</head>
<body>
  <h1><img src="Alchimoji_Logo.png" alt="Alchimoji Logo""></h1>

  <!-- <form id="alchimoji-form" style="text-align: left;"> -->
  <form id="assetForm" style="text-align: left;">
  <!-- Logo -->
  <!-- <img src="assets/Alchimoji_Logo.png" alt="Alchimoji Logo" style="height: 60px; margin-bottom: 10px;" /> -->

  <!-- Audiencias -->
  <div class="form-section">
    <strong>🎯 Audiencias:</strong>
    <label><input type="checkbox" name="audiencia" value="gamers"> 🎮 Gamers</label>
    <label><input type="checkbox" name="audiencia" value="streaming"> 📺 Streaming</label>
    <label><input type="checkbox" name="audiencia" value="melomaniac"> 🎵 Melómanos</label>
  </div>

  <!-- Momento del día -->
  <div class="form-section">
    <strong>🕒 Momento del día:</strong>
    <label><input type="checkbox" name="momento" value="dia"> 🌞 Día</label>
    <label><input type="checkbox" name="momento" value="noche"> 🌙 Noche</label>
  </div>

  <!-- Logos -->
  <div class="form-section">
    <strong>🏷️ Logo:</strong>
    <label>
      <select name="logoSelect" id="logoSelect">
        <option value="" disabled selected>Selecciona un logo</option>
      </select>
    </label>
  </div>

  <!-- Copies -->
  <div class="form-section" style="flex-direction: column; align-items: flex-start;">
    <strong>📝 Copies:</strong>

    <label style="margin-left: 16px; width: 100%;">
      <input type="checkbox" name="copy1">
      Texto 1:
      <input type="text" maxlength="60" name="copyText1" placeholder="Texto 1..." style="margin-left: 8px; width: 60%;">
      <input type="color" name="copyColor1" value="#ffffff" title="Color del texto">
    </label>

    <label style="margin-left: 16px; width: 100%;">
      <input type="checkbox" name="copy2">
      Texto 2:
      <input type="text" maxlength="60" name="copyText2" placeholder="Texto 2..." style="margin-left: 8px; width: 60%;">
      <input type="color" name="copyColor2" value="#ffffff" title="Color del texto">
    </label>

    <label style="margin-left: 16px; width: 100%;">
      <input type="checkbox" name="copy3">
      Texto 3:
      <input type="text" maxlength="60" name="copyText3" placeholder="Texto 3..." style="margin-left: 8px; width: 60%;">
      <input type="color" name="copyColor3" value="#ffffff" title="Color del texto">
    </label>
  </div>

  <!-- Íconos -->
  <div class="form-section" style="flex-direction: column; align-items: flex-start;">
    <strong>🧩 Íconos:</strong>

    <label style="margin-left: 16px;">
      <input type="checkbox" name="icon1">
      Icono 1:
      <select name="iconSelect1" style="margin-left: 8px;">
        <!-- <option value="icon1.png">icon1.png</option> -->
        <!-- <option value="icon2.png">icon2.png</option> -->
      </select>
    </label>

    <label style="margin-left: 16px;">
      <input type="checkbox" name="icon2">
      Icono 2:
      <select name="iconSelect2" style="margin-left: 8px;">
        <!-- <option value="icon1.png">icon1.png</option> -->
        <!-- <option value="icon2.png">icon2.png</option> -->
      </select>
    </label>

    <label style="margin-left: 16px;">
      <input type="checkbox" name="icon3">
      Icono 3:
      <select name="iconSelect3" style="margin-left: 8px;">
        <!-- <option value="icon1.png">icon1.png</option> -->
        <!-- <option value="icon2.png">icon2.png</option> -->
      </select>
    </label>
  </div>

  <!-- Tamaños -->
  <div class="form-section">
    <strong>📐 Tamaños:</strong>
    <label><input type="checkbox" name="size" value="300x600"> 300x600</label>
    <label><input type="checkbox" name="size" value="728x90"> 728x90</label>
    <label><input type="checkbox" name="size" value="300x250"> 300x250</label>
    <label><input type="checkbox" name="size" value="320x50"> 320x50</label>
    <label><input type="checkbox" name="size" value="160x600"> 160x600</label>
  </div>

  <!-- Botones -->
  <div class="form-section">
    <!-- <button type="button" onclick="generateCreatives()">Generar creatividades</button> -->
    <button id="generateBtn" type="submit">Generar creatividades</button>
    <!-- <button type="button" onclick="downloadAll()">Descargar todas</button> -->
    <button id="downloadAllBtn" type="button">Descargar todas</button>
  </div>
  </form>



  <div class="preview-container" id="previewContainer"></div>

  <script>
    const form = document.getElementById('assetForm');
    const previewContainer = document.getElementById('previewContainer');
    const downloadAllBtn = document.getElementById('downloadAllBtn');
    const baseURL = "https://cdn.jsdelivr.net/gh/icarlso8/TRKKN_CoT/assets";
    let generatedImages = [];
    let generatedMetadata = [];

    function downloadURI(uri, name) {
      const link = document.createElement("a");
      link.download = name;
      link.href = uri;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

      function generateID() {
        return Math.random().toString(36).substring(2, 10) + Date.now().toString(36);
      }
      
      function getLocalTimestampISO() {
        const now = new Date();
        const tzOffset = -now.getTimezoneOffset(); // en minutos
        const sign = tzOffset >= 0 ? "+" : "-";
        const pad = n => String(Math.floor(Math.abs(n))).padStart(2, '0');
        const offsetHours = pad(tzOffset / 60);
        const offsetMinutes = pad(tzOffset % 60);
        return now.toISOString().replace("Z", `${sign}${offsetHours}:${offsetMinutes}`);
      }
    
      function generateVariantID(meta) {
        const variantString = [
          meta.audiencia,
          meta.momento,
          meta.tamano,
          meta.copies.join(';'),
          meta.logo || "",
          meta.iconos.join(';')
        ].join('|');
        return btoa(unescape(encodeURIComponent(variantString))).substring(0, 20); // Base64 recortado
      }

      form.addEventListener('submit', function (e) {
      e.preventDefault();
      previewContainer.innerHTML = '';
      generatedImages = [];
    
      const audiencias = [...form.querySelectorAll('input[name="audiencia"]:checked')].map(el => el.value);
      const momentos = [...form.querySelectorAll('input[name="momento"]:checked')].map(el => el.value);
      const sizes = [...form.querySelectorAll('input[name="size"]:checked')].map(el => el.value);
      const copies = [];
    
      if (form.copy1.checked) copies.push({ text: form.copyText1.value, color: form.copyColor1.value });
      if (form.copy2.checked) copies.push({ text: form.copyText2.value, color: form.copyColor2.value });
      if (form.copy3.checked) copies.push({ text: form.copyText3.value, color: form.copyColor3.value });
    
      audiencias.forEach(aud => {
        momentos.forEach(mom => {
          sizes.forEach(size => {
            const fondoPath = `${baseURL}/${aud}/${mom}/${aud}_${mom}_01.png`;
            const logoPath = form.logoSelect.value ? form.logoSelect.value.replace('assets', baseURL) : '';
    
            const canvas = document.createElement('canvas');
            const [w, h] = size.split('x').map(Number);
            canvas.width = w;
            canvas.height = h;
            const ctx = canvas.getContext('2d');
    
            const fondoImg = new Image();
            fondoImg.crossOrigin = "anonymous";
            fondoImg.src = fondoPath;
    
            const logoImg = new Image();
            logoImg.crossOrigin = "anonymous";
            logoImg.src = logoPath;
    
            const iconPaths = ['iconSelect1', 'iconSelect2', 'iconSelect3'].map((iconSelect, index) => {
              const isChecked = form[`icon${index + 1}`]?.checked;
              const path = form[iconSelect]?.value;
              return isChecked && path ? path.replace('assets', baseURL) : null;
            }).filter(Boolean);
    
            const loadImage = (src) => {
              return new Promise(resolve => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                img.onload = () => resolve(img);
                img.src = src;
              });
            };
    
            Promise.all([
              loadImage(fondoPath),
              logoPath ? loadImage(logoPath) : null,
              ...iconPaths.map(loadImage)
            ]).then(([fondo, logo, ...icons]) => {
              ctx.drawImage(fondo, 0, 0, w, h);
              if (logo) ctx.drawImage(logo, 10, 10, 40, 40);
    
              icons.forEach((icon, i) => {
                ctx.drawImage(icon, w - 40, 10 + i * 40, 30, 30);
              });
    
              copies.forEach((copy, index) => {
                ctx.fillStyle = copy.color || "#ffffff";
                ctx.font = "bold 14px Mulish";
                ctx.fillText(copy.text, 10, h - 20 - index * 20);
              });
    
              const dataURL = canvas.toDataURL("image/png");
              const fileName = `${aud}_${mom}_${size}.png`;
    
              const div = document.createElement('div');
              div.className = 'preview';
              div.style.width = w + 'px';
              div.style.height = h + 'px';
              div.innerHTML = `
                <img src="${dataURL}" alt="Creatividad" />
                <button onclick="downloadURI('${dataURL}', '${fileName}')">Descargar</button>
              `;
              previewContainer.appendChild(div);
              generatedImages.push({ name: fileName, data: dataURL });

              const timestamp = getLocalTimestampISO();
              const metadata = {
                nombre: fileName,
                audiencia: aud,
                momento: mom,
                tamano: size,
                copies: copies.map(c => c.text),
                logo: logoPath ? logoPath.split('/').pop() : null,
                iconos: iconPaths.map(p => p.split('/').pop())
              };
              metadata.variant_id = generateVariantID(metadata);
              metadata.timestamp = timestamp;
              metadata.id = `${metadata.variant_id}-${timestamp}`;
              generatedMetadata.push(metadata);
            });
          });
        });
      });
    });

    // Descarga completa organizada por audiencia / momento / tamaño
    downloadAllBtn.addEventListener('click', async () => {
      if (!generatedImages.length) {
        alert("Primero genera creatividades.");
        return;
      }
    
      const zip = new JSZip();
    
      generatedImages.forEach(img => {
        // Extrae partes del nombre
        const [audiencia, momento, size] = img.name.replace('.png', '').split('_');
        const folderPath = `${audiencia}/${momento}/${size}`;
        zip.folder(folderPath).file(`${img.name}`, img.data.split(',')[1], { base64: true });
      });

      zip.file("alchimoji_metadata.json", JSON.stringify(generatedMetadata, null, 2));

      // Convertir metadata a CSV
      const csvHeader = "id,variant_id,timestamp,nombre,audiencia,momento,tamano,copies,logo,iconos";
      const csvRows = generatedMetadata.map(meta => {
        return [
          meta.id,
          meta.variant_id,
          meta.timestamp,
          meta.nombre,
          meta.audiencia,
          meta.momento,
          meta.tamano,
          `"${meta.copies.join(';')}"`,
          meta.logo || "",
          `"${meta.iconos.join(';')}"`
        ].join(",");
      });
      const csvContent = [csvHeader, ...csvRows].join("\n");
      zip.file("alchimoji_metadata.csv", csvContent);

      const blob = await zip.generateAsync({ type: "blob" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "alchimoji_creatividades.zip";
      link.click();
    });

    // Cargar dinámicamente los íconos desde el JSON -> Solo se debe actualizar el JSON
    fetch('assets/icons/icons.json')
      .then(response => response.json())
      .then(iconList => {
        ['iconSelect1', 'iconSelect2', 'iconSelect3'].forEach(selectName => {
          const select = document.querySelector(`select[name="${selectName}"]`);
          if (!select) return;
          /* select.innerHTML = ''; // Limpiar opciones previas */
          select.innerHTML = '<option value="" disabled selected>Selecciona un ícono</option>';
          iconList.forEach(icon => {
            const option = document.createElement('option');
            option.value = `assets/icons/${icon}`;
            option.textContent = icon;
            select.appendChild(option);
          });
        });

            // Cargar logos dinámicamente
    fetch('assets/logos/logos.json')
      .then(response => response.json())
      .then(logoList => {
        const select = document.querySelector('select[name="logoSelect"]');
        select.innerHTML = '<option value="" disabled selected>Selecciona un logo</option>';
        logoList.forEach(logo => {
          const option = document.createElement('option');
          option.value = `assets/logos/${logo}`;
          option.textContent = logo;
          select.appendChild(option);
        });
      })
      .catch(error => console.error('Error cargando logos:', error));
      })
      .catch(error => console.error('Error cargando íconos:', error));
    
  </script>
</body>
</html>
